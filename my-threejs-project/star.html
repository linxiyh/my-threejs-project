<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js 入门级粒子系统 - 旋转星系</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 1. 场景基础设置
        // =================================================================
        const scene = new THREE.Scene();

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(3, 3, 5); // 将相机放置在斜上方，方便观察

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // 2. 创建星系粒子系统
        // =================================================================

        // --- 定义星系的参数，方便调整 ---
        const parameters = {
            count: 100000, // 粒子数量
            size: 0.01,    // 粒子大小
            radius: 5,     // 星系半径
            branches: 3,   // 旋臂数量
            spin: 1,       // 旋臂弯曲度
            randomness: 0.2, // 粒子位置随机性
            randomnessPower: 3, // 随机性影响因子
            insideColor: '#ff6030', // 星系内部颜色
            outsideColor: '#1b3984', // 星系外部颜色
        };

        let galaxyGeometry = null;
        let galaxyMaterial = null;
        let galaxyPoints = null;

        const generateGalaxy = () => {
            // 如果已有星系，先销毁旧的几何体和材质，防止内存泄漏
            if (galaxyPoints !== null) {
                galaxyGeometry.dispose();
                galaxyMaterial.dispose();
                scene.remove(galaxyPoints);
            }

            // --- 创建几何体和属性数组 ---
            galaxyGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(parameters.count * 3); // 每个点3个坐标 (x, y, z)
            const colors = new Float32Array(parameters.count * 3);    // 每个点3个颜色值 (r, g, b)

            const colorInside = new THREE.Color(parameters.insideColor);
            const colorOutside = new THREE.Color(parameters.outsideColor);

            // --- 循环生成每个粒子的位置和颜色 ---
            for (let i = 0; i < parameters.count; i++) {
                const i3 = i * 3;

                // 随机生成一个半径，表示粒子距离中心的距离
                const radius = Math.random() * parameters.radius;

                // 计算粒子在哪一个旋臂上
                const branchAngle = (i % parameters.branches) / parameters.branches * Math.PI * 2;
                
                // 根据半径增加旋转角度，形成螺旋效果
                const spinAngle = radius * parameters.spin;
                
                // 为粒子位置添加随机偏移，让星系看起来更自然
                const randomX = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness;
                const randomY = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness;
                const randomZ = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness;

                // 计算粒子的最终x, y, z坐标
                positions[i3] = Math.cos(branchAngle + spinAngle) * radius + randomX;
                positions[i3 + 1] = randomY;
                positions[i3 + 2] = Math.sin(branchAngle + spinAngle) * radius + randomZ;

                // --- 设置颜色 ---
                // 根据粒子距离中心的远近，进行颜色插值
                const mixedColor = colorInside.clone();
                mixedColor.lerp(colorOutside, radius / parameters.radius);

                colors[i3] = mixedColor.r;
                colors[i3 + 1] = mixedColor.g;
                colors[i3 + 2] = mixedColor.b;
            }

            // 将位置和颜色数据设置到几何体属性中
            galaxyGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            galaxyGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            // --- 创建材质 ---
            galaxyMaterial = new THREE.PointsMaterial({
                size: parameters.size,
                sizeAttenuation: true,      // 粒子大小是否因距离而衰减
                depthWrite: true,          // 渲染透明物体时，关闭深度写入以避免遮挡问题
                blending: THREE.AdditiveBlending, // 混合模式，让粒子重叠时更亮，产生发光效果
                vertexColors: true          // 关键！启用顶点颜色，这样每个粒子才能显示我们设置的颜色
            });

            // --- 创建Points对象 ---
            galaxyPoints = new THREE.Points(galaxyGeometry, galaxyMaterial);
            scene.add(galaxyPoints);
        };

        generateGalaxy(); // 首次生成星系

        // 3. 动画循环 (Animation Loop)
        // =================================================================
        const clock = new THREE.Clock();

        const animate = () => {
            const elapsedTime = clock.getElapsedTime();

            // 动画非常简单：只需旋转整个粒子系统
            if (galaxyPoints) {
                galaxyPoints.rotation.y = elapsedTime * 0.1;
            }

            // 更新控制器
            controls.update();

            // 渲染场景
            renderer.render(scene, camera);

            // 请求下一帧
            requestAnimationFrame(animate);
        };

        animate();

        // 4. 窗口自适应
        // =================================================================
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        });
    </script>
</body>
</html>